name: CMake

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main, dev ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout code with submodules (for GLM, GLAD, STB)
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    # Install system dependencies
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          mesa-common-dev \
          libx11-dev \
          libxrandr-dev \
          libxi-dev \
          libxcursor-dev \
          libxinerama-dev \
          libxxf86vm-dev \
          xvfb \
          xauth

    - name: Test Xvfb
      run: |
        Xvfb :99 -screen 0 1024x768x24 &
        sleep 2
        ps aux | grep Xvfb

    # Verify installed versions
    - name: Check Versions
      run: |
        echo "CMake version:"
        cmake --version
        echo "GCC version:"
        gcc --version
        echo "G++ version:"
        g++ --version

    # Configure CMake
    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -G Ninja

    # Build the project
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel

    # Optional: Upload build artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: compute-${{env.BUILD_TYPE}}-linux
        path: |
          ${{github.workspace}}/build/compute
          ${{github.workspace}}/build/shaders/
        retention-days: 7
